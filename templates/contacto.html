# Función que envía el email en un hilo separado
def send_async_email(msg):
    with app.app_context():
        try:
            mail.send(msg)
            print("Email de cotización enviado con éxito en hilo de fondo.")
        except Exception as e:
            print(f"ERROR CRÍTICO AL ENVIAR EMAIL ASÍNCRONO: {e}")

# 5. Ruta del Formulario de Contacto (AHORA CON HILO)
@app.route('/contacto', methods=['GET', 'POST'])
def contacto():
    if request.method == 'POST':
        # 1. Recoger datos del formulario
        nombre = request.form.get('nombre')
        email = request.form.get('email')
        tipo_proyecto = request.form.get('tipo_proyecto')
        mensaje = request.form.get('mensaje')

        # 2. Crear el Contenido del Email
        cuerpo_email = f"""
        ¡NUEVA SOLICITUD DE COTIZACIÓN WEB!

        Nombre: {nombre}
        Email de Contacto: {email}
        Tipo de Proyecto: {tipo_proyecto}

        Mensaje:
        {mensaje}
        """

        # 3. Crear el mensaje de correo
        msg = Message(
            subject=f'NUEVA COTIZACIÓN WEB: {tipo_proyecto}',
            sender=app.config['MAIL_USERNAME'],
            recipients=['robinsonceramista@gmail.com'], 
            body=cuerpo_email
        )

        # 4. INICIAR EL ENVÍO EN UN HILO DE FONDO Y CONTINUAR INMEDIATAMENTE
        thread = threading.Thread(target=send_async_email, args=[msg])
        thread.start()

        # 5. Mostrar página de agradecimiento INMEDIATAMENTE
        return render_template('gracias.html', nombre=nombre)

    # Si es un método GET, simplemente muestra el formulario
    return render_template('contacto.html')